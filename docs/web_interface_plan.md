# План автоматизації генерації вибіркових whitelist-файлів через веб-інтерфейс

## 1. Користувацький сценарій та вимоги

### Основні ролі
- **Адміністратор Pi-hole** — має доступ до веб-інтерфейсу Pi-hole та керує білим списком.
- **Редактор списків** — відповідає за підтримку категорій доменів у Git-репозиторії та може експортувати списки для адміністраторів.

### Ключовий сценарій
1. Користувач відкриває веб-інтерфейс Pi-hole та переходить до нового розділу "Whitelist Builder".
2. Інтерфейс завантажує перелік доступних категорій із репозиторію або локального каталогу `categories/`.
3. Користувач обирає потрібні категорії (одну або кілька) та додаткові опції обробки.
4. Після натискання кнопки "Згенерувати" бекенд формує тимчасовий whitelist-файл.
5. Користувач може:
   - завантажити сформований файл;
   - переглянути попередній список доменів (з пагінацією та пошуком);
   - одразу застосувати whitelist до Pi-hole.
6. Результати логуються, а користувач бачить повідомлення про успіх або помилки (наприклад, недоступні файли категорій).

### Необхідні опції
- Вибір категорій за допомогою чекбоксів із коротким описом кожної категорії.
- Можливість додати власний файл/каталог (шлях на сервері) до генерації.
- Перемикач "Включати зовнішні джерела" (аналог змінної `INCLUDE_EXTERNAL_SOURCES`).
- Поле для вказання альтернативного комбінованого файлу джерел (`SOURCES_COMBINED`).
- Кнопка "Очистити вибір" для швидкого скидання стану форми.
- Індикація кількості доменів у кожній категорії (дані беруться з попередньої індексації або розраховуються на льоту).

### Нефункціональні вимоги
- **Безпека:** доступ до розділу лише для авторизованих користувачів Pi-hole.
- **Продуктивність:** генерація списку до 5 секунд для наборів до 10 000 доменів.
- **Аудит:** логування кожної операції у `/var/log/pihole-whitelist-builder.log` з інформацією про користувача та параметри генерації.
- **Розширюваність:** можливість додавати нові категорії без змін у коді (через автоматичне сканування каталогу).

## 2. API та бекенд-скрипт

### Архітектура
- Веб-інтерфейс викликає CGI- або REST-ендпоінти Pi-hole (написані на bash або Python).
- Основна логіка винесена до нового скрипту `build_whitelist.sh`, який повторно використовує існуючий `generate_whitelist.sh`.

### Структура каталогу
```
/var/www/html/admin/scripts/pi-hole/php/
  ├── whitelist_builder.php        # REST-ендпоінт, обробка запитів з UI
  └── whitelist_builder_helpers.sh # Допоміжні shell-функції (опціонально)
/usr/local/bin/
  └── build_whitelist.sh           # Основний скрипт формування списку
```

### Формат запиту до бекенду
`POST /admin/api/whitelist-builder`
```json
{
  "categories": ["base.txt", "apple.txt"],
  "extra_paths": ["/srv/custom-lists"],
  "include_external": true,
  "sources_combined": "",
  "apply_directly": false
}
```

### Відповідь бекенду
```json
{
  "status": "ok",
  "domain_count": 425,
  "download_url": "/admin/tmp/whitelist-20240719-103000.txt"
}
```
У разі помилки повертається `status: "error"` та масив повідомлень.

### Логіка `build_whitelist.sh`
1. Прийняти параметри CLI (список категорій, додаткові шляхи, прапорець застосування, шлях до комбінованого файлу джерел).
2. Підготувати тимчасовий робочий каталог (наприклад, `/tmp/whitelist-builder-XXXX`).
3. Сформувати команду виклику `generate_whitelist.sh`, передаючи вибрані файли та каталоги.
4. За потреби виключити зовнішні джерела (`INCLUDE_EXTERNAL_SOURCES=0`).
5. Після генерації:
   - повернути шлях до файлу;
   - при `apply_directly=1` викликати `apply_whitelist.sh` з отриманим файлом;
   - записати подію до журналу.
6. Очистити тимчасові файли після завершення або через cron.

### Псевдокод CLI
```bash
build_whitelist.sh \
  --categories "base.txt,apple.txt" \
  --extra-path "/srv/custom" \
  --include-external 1 \
  --sources-combined "" \
  --apply-directly 0
```

## 3. Макет веб-інтерфейсу

```
+----------------------------------------------------------+
| Whitelist Builder                                        |
+----------------------------------------------------------+
| [ ] Усі категорії                                        |
| [x] base.txt – Базові домени (215)                       |
| [ ] apple.txt – Сервіси Apple (38)                       |
| [x] ukrainian_services.txt – Українські сервіси (64)     |
| ...                                                      |
+----------------------------------------------------------+
| Додаткові параметри                                      |
| [ ] Включати зовнішні джерела                            |
| [ Sources combined: ________________________________ ]   |
| [ Додатковий шлях:  ________________________________ ]   |
| [Додати] [Очистити]                                      |
+----------------------------------------------------------+
| [Згенерувати] [Застосувати до Pi-hole]                   |
+----------------------------------------------------------+
| Підсумок: 279 доменів                                    |
| [Завантажити файл] [Переглянути список]                  |
+----------------------------------------------------------+
| Журнал операцій                                          |
| 10:30 user@host згенерував файл (base, ukrainian)        |
+----------------------------------------------------------+
```

Макет відповідає дизайну Pi-hole: використовуються стандартні компоненти Bootstrap, а розмітка адаптивна для планшетів.

## 4. Вплив на існуючі скрипти

### `generate_whitelist.sh`
- Потрібно додати підтримку приймання списку шляхів через стандартний ввід або JSON. Для сумісності з поточними сценаріями запропоновано **не змінювати** синтаксис, а викликати скрипт із параметрами, які вже підтримуються (шляхи до файлів та каталогів).
- Варто додати опцію `--output`, щоб бекенд міг керувати місцем розташування тимчасового файлу. Якщо така опція буде реалізована, необхідно написати юніт-тест у `tests/test_generate_whitelist.sh` для перевірки створення файлу за кастомним шляхом.

### `apply_whitelist.sh`
- Скрипт вже приймає шлях до файлу як аргумент. Достатньо переконатися, що бекенд передає абсолютний шлях.
- Рекомендується додати логування та можливість dry-run (`--dry-run`) для попереднього перегляду. У разі реалізації потрібно покрити тестом сценарій, коли домени лише виводяться, а не застосовуються.

### Додаткові кроки
- Оновити `tests/` новими кейсами після впровадження CLI-опцій.
- Перевірити `update_and_apply.sh`, щоб він міг використовувати ті ж тимчасові файли, якщо автоматизація буде розширена на cron-завдання.

## 5. Наступні дії
- Погодити UX-макет з користувачами та зібрати відгуки.
- Створити прототип `build_whitelist.sh` з мінімальною логікою виклику `generate_whitelist.sh`.
- Додати REST-ендпоінт до Pi-hole та інтегрувати його в панель адміністрування.
- Підготувати тестовий сценарій у середовищі Pi-hole v5 та v6.
- Оновити документацію (`README.md`) після реалізації перших прототипів.
