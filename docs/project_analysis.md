# Аналітичний звіт про стан проєкту

> English version: [docs/project_analysis.en.md](project_analysis.en.md)

## 1. Призначення та контекст
- Репозиторій надає готові списки доменів для білого списку Pi-hole та інструменти з автоматизації їх отримання, очищення і застосування. Основний файл `whitelist.txt` використовується як універсальний комбінований список, а каталог `categories/` містить тематичні добірки для вибіркового імпорту.
- Супровід ведеться українською та англійською мовами. Детальна інструкція з використання розміщена у `README.md`, включно з прикладами для Pi-hole v5/v6, сценаріями автоматичного оновлення та описом зовнішніх джерел. Це забезпечує зрозумілий онбординг для адміністраторів Pi-hole.

## 2. Структура та ключові компоненти
- **Статичні дані:** `whitelist.txt` (904 домени) та 26 тематичних файлів у `categories/*.txt`, зокрема найбільші добірки `extended_services.txt`, `apple.txt`, `ukrainian_services.txt`, `microsoft_onedrive.txt`, `gaming.txt`.
- **Основні скрипти:**
  - `generate_whitelist.sh` — формує комбінований whitelist, підтримує вибіркові аргументи, змінні середовища та опцію `--output` для кастомного файлу.【F:generate_whitelist.sh†L1-L90】
  - `apply_whitelist.sh` — застосовує список до Pi-hole, визначає команду для v5/v6, ігнорує коментарі та порожні рядки.【F:apply_whitelist.sh†L1-L47】
  - `build_whitelist.sh` — обгортка для інтерактивних сценаріїв (прототип), приймає перелік категорій, додаткові шляхи та може одразу викликати `apply_whitelist.sh`.【F:build_whitelist.sh†L1-L137】
  - `fetch_sources.sh` — завантажує зовнішні джерела, нормалізує формати (uBlock, hosts, dnsmasq), агрегує у `sources/generated/all_sources.txt`.【F:fetch_sources.sh†L1-L118】
  - `cleanup_whitelist.sh` — перевіряє доступність доменів, веде стан невдалих перевірок та переносить проблемні записи до `deprecated.txt` після порогового числа помилок.【F:cleanup_whitelist.sh†L1-L125】
  - `check_duplicates.sh` — шукає дублікати та (опційно) перевіряє DNS, підтримує прапорець `SKIP_DNS_CHECK`.【F:check_duplicates.sh†L1-L70】
  - `sort_categories.sh` — впорядковує домени в категоріях, зберігає коментарі вгорі файлу.【F:sort_categories.sh†L1-L40】
  - `update_and_apply.sh` — завантажує актуальний whitelist з GitHub і застосовує його через локальний Pi-hole, логуючи операцію.【F:update_and_apply.sh†L1-L43】
- **Документація:** `docs/web_interface_plan.md` описує цільовий веб-інтерфейс для вибіркової генерації списків та вимоги до бекенду.【F:docs/web_interface_plan.md†L1-L115】

## 3. Дані та джерела
- `whitelist.txt` містить 904 активні записи після дедуплікації й сортування. Автоматично додається заголовок з поясненням і всі коментарі видаляються скриптом генерації.
- Каталог `categories/` охоплює 26 тематичних наборів, що дає змогу підлаштовувати whitelist під конкретні бізнес-потреби. Найбільші набори — `extended_services.txt` (212 доменів), `apple.txt` (111), `ukrainian_services.txt` (61), `microsoft_onedrive.txt` (56), `gaming.txt` (34).
- `sources/default_sources.txt` підключає зовнішні whitelist-и (AnudeepND тощо), які нормалізуються в уніфікований формат, після чого можуть бути включені або вимкнені через змінні середовища у `generate_whitelist.sh`.【F:sources/default_sources.txt†L1-L8】【F:generate_whitelist.sh†L8-L24】【F:fetch_sources.sh†L1-L118】

## 4. Автоматизація, тести та CI
- Каталог `tests/` містить інтеграційні сценарії для основних скриптів (генерація, застосування, завантаження джерел, сортування, оновлення). Тести емулюють зовнішні залежності (наприклад, команди `pihole`, мережеві запити) та перевіряють ключові гілки логіки.【F:tests/generate_whitelist_test.sh†L1-L73】【F:tests/apply_whitelist_test.sh†L1-L46】
- У `.github/workflows/duplicate_check.yml` реалізовано перевірку дублікатів і актуальності `whitelist.txt` для pull request-ів, а `weekly_check.yml` запускає щотижневу діагностику з автоматичним створенням issue для недоступних доменів.【F:.github/workflows/duplicate_check.yml†L1-L24】【F:.github/workflows/weekly_check.yml†L1-L33】
- Новий workflow `ci.yml` виконує всі сценарії з каталогу `tests/`, забезпечуючи smoke-тест REST API, shell-утиліт та статичний аналіз перед злиттям.【F:.github/workflows/ci.yml†L1-L31】
- Відсутні автоматизовані метрики покриття чи звіти про продуктивність. Наявні тести орієнтовані на сценарії командної оболонки, але не охоплюють веб-інтерфейс (який поки не реалізований) та не фіксують статистику стану доменів.

## 5. Сильні сторони
- Детальна документація з прикладами встановлення та автоматизації (`README.md`), а також попередньо продуманий план розвитку веб-інтерфейсу.
- Широкий набір утиліт для обробки списків: генерація, сортування, перевірка дублікатів, очистка та оновлення.
- З'явився скрипт експорту `export_whitelist.sh`, що готує whitelist у форматах AdGuard Home та pfBlockerNG для сумісних рішень.
- Наявність CI-воркфлоу для моніторингу якості списків і регулярний моніторинг доступності доменів.
- Інтеграційні тести покривають ключові сценарії роботи shell-скриптів, що зменшує ризики регресій.

## 6. Прогалини та ризики
- Немає централізованого механізму відстеження метрик (кількість активних/видалених доменів, частота збоїв у fetch), що ускладнює планування.
- Проєкт залежить від зовнішніх джерел без кешування чи дзеркал, тому збій стороннього ресурсу блокує оновлення.
- Відсутня автоматизована валідація структури/змісту файлів категорій на рівні описових метаданих (наприклад, теги, коментарі) та немає інструменту для напівавтоматичного оновлення коментарів про причину додавання домену.
- План веб-інтерфейсу ще не реалізований; бракує бекенд-реалізації та користувацьких тестів, що затримує розширення аудиторії.

## 7. Дорожня карта (roadmap)
### Фаза 0–1 місяць
1. Додати звіт про статистику категорій і зовнішніх джерел (кількість доменів, частка недоступних, дата останньої перевірки) з вивантаженням у `docs/`.
2. Автоматизувати кешування та ретраї для `fetch_sources.sh`, щоб зменшити залежність від тимчасових збоїв.
3. Розширити тести для `cleanup_whitelist.sh` і `check_duplicates.sh`, покривши сценарії з прапорцями та паралельністю.

### Фаза 1–2 місяці
1. Реалізувати CLI- та API-функціонал з `docs/web_interface_plan.md`: завершити `build_whitelist.sh`, додати REST/CGI-ендпоінт і базову веб-форму для вибіркового складання whitelist-ів.
2. Інтегрувати нові можливості в CI (наприклад, smoke-тест веб-ендпоінту, тестування REST API та dry-run `apply_whitelist.sh`).
3. Підготувати інструкції з розгортання веб-інтерфейсу (оновити README, додати розділ у `docs/`).

### Фаза 2–4 місяці
1. Додати систему метаданих для категорій (опис, автор, дата ревізії) та автоматичну перевірку заповнення цих полів.
2. Побудувати панель моніторингу (наприклад, через GitHub Pages або простий HTML-звіт) з графіком змін кількості доменів та журналом видалень.
3. Запровадити механізм пропозицій/рев'ю доменів через pull request шаблони та автоматичну перевірку коментарів у категоріях.

### Фаза 4+ місяців
1. Дослідити інтеграцію з іншими DNS-рішеннями (AdGuard Home, pfBlockerNG) і додати експорт у їхні формати.
2. Розглянути впровадження невеликої бази даних для збереження історії перевірок доменів і аналітики (SQLite + експорт у CSV/JSON).
3. Провести користувацькі дослідження веб-інтерфейсу, зібрати відгуки й оптимізувати UX (пошук, групування, збережені профілі). Підготувати A/B-експерименти для оцінки зручності.
